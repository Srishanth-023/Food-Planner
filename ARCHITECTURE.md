# NutriVision AI - System Architecture

## High-Level Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    CLIENT LAYER                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │                           React + Vite Frontend                                      ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ ││
│  │  │   Auth UI    │  │  Dashboard   │  │ Food Upload  │  │   GenAI Chat Assistant   │ ││
│  │  │  (Login/Reg) │  │  & Progress  │  │  & Analysis  │  │   (Natural Language)     │ ││
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────────────────┘ ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ ││
│  │  │  Meal Plan   │  │ Workout Plan │  │   Profile    │  │     Charts (Chart.js)    │ ││
│  │  │   Viewer     │  │    Viewer    │  │   Settings   │  │   Weight/Calorie Trends  │ ││
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────────────────┘ ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           │ HTTPS (REST API / WebSocket)
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                  API GATEWAY LAYER                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │                         Node.js + Express Backend                                    ││
│  │  ┌──────────────────────────────────────────────────────────────────────────────┐   ││
│  │  │                            Middleware Stack                                   │   ││
│  │  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────────────────┐  │   ││
│  │  │  │   CORS     │  │   Morgan   │  │  Helmet    │  │  Rate Limiter          │  │   ││
│  │  │  │  Handler   │  │  (Logger)  │  │ (Security) │  │  (express-rate-limit)  │  │   ││
│  │  │  └────────────┘  └────────────┘  └────────────┘  └────────────────────────┘  │   ││
│  │  └──────────────────────────────────────────────────────────────────────────────┘   ││
│  │                                                                                      ││
│  │  ┌───────────────────────────────────────────────────────────────────────────────┐  ││
│  │  │                              REST API Routes                                   │  ││
│  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌──────────┐ │  ││
│  │  │  │ /api/auth   │ │ /api/users  │ │ /api/food   │ │ /api/plans  │ │ /api/chat│ │  ││
│  │  │  │ - register  │ │ - profile   │ │ - analyze   │ │ - meal      │ │ - message│ │  ││
│  │  │  │ - login     │ │ - update    │ │ - log       │ │ - workout   │ │ - history│ │  ││
│  │  │  │ - refresh   │ │ - settings  │ │ - history   │ │ - generate  │ │          │ │  ││
│  │  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ └──────────┘ │  ││
│  │  │  ┌─────────────┐ ┌─────────────┐                                              │  ││
│  │  │  │/api/progress│ │/api/nutrition                                              │  ││
│  │  │  │ - weight    │ │ - search    │                                              │  ││
│  │  │  │ - calories  │ │ - gi-lookup │                                              │  ││
│  │  │  │ - stats     │ │             │                                              │  ││
│  │  │  └─────────────┘ └─────────────┘                                              │  ││
│  │  └───────────────────────────────────────────────────────────────────────────────┘  ││
│  │                                                                                      ││
│  │  ┌───────────────────────────────────────────────────────────────────────────────┐  ││
│  │  │                           Authentication Layer                                 │  ││
│  │  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────────────┐ │  ││
│  │  │  │  JWT Generator   │  │  Token Validator │  │  Refresh Token Handler       │ │  ││
│  │  │  │  (Access Token)  │  │  (Middleware)    │  │  (Rotation Strategy)         │ │  ││
│  │  │  └──────────────────┘  └──────────────────┘  └──────────────────────────────┘ │  ││
│  │  └───────────────────────────────────────────────────────────────────────────────┘  ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                         ┌─────────────────┼─────────────────┐
                         │                 │                 │
                         ▼                 ▼                 ▼
┌────────────────────────────┐ ┌─────────────────────────────────────────────────────────┐
│      MongoDB Atlas         │ │                    AI MICROSERVICE                       │
│  ┌──────────────────────┐  │ │  ┌───────────────────────────────────────────────────┐  │
│  │   Users Collection   │  │ │  │              Python + FastAPI                      │  │
│  │  - _id               │  │ │  │  ┌─────────────────────────────────────────────┐  │  │
│  │  - email             │  │ │  │  │              Endpoints                       │  │  │
│  │  - passwordHash      │  │ │  │  │  ┌───────────────┐  ┌───────────────────┐   │  │  │
│  │  - profile           │  │ │  │  │  │ POST /analyze │  │ POST /generate    │   │  │  │
│  │  - preferences       │  │ │  │  │  │   -image      │  │   -meal-plan      │   │  │  │
│  │  - createdAt         │  │ │  │  │  └───────────────┘  └───────────────────┘   │  │  │
│  └──────────────────────┘  │ │  │  │  ┌───────────────┐  ┌───────────────────┐   │  │  │
│  ┌──────────────────────┐  │ │  │  │  │ POST /chat    │  │ POST /generate    │   │  │  │
│  │  FoodLogs Collection │  │ │  │  │  │   -completion │  │   -workout-plan   │   │  │  │
│  │  - _id               │  │ │  │  │  └───────────────┘  └───────────────────┘   │  │  │
│  │  - userId            │  │ │  │  │  ┌───────────────┐                          │  │  │
│  │  - foods[]           │  │ │  │  │  │ POST /portion │                          │  │  │
│  │  - totalCalories     │  │ │  │  │  │   -estimate   │                          │  │  │
│  │  - date              │  │ │  │  │  └───────────────┘                          │  │  │
│  └──────────────────────┘  │ │  │  └─────────────────────────────────────────────┘  │  │
│  ┌──────────────────────┐  │ │  │                                                    │  │
│  │ WeightLogs Collection│  │ │  │  ┌─────────────────────────────────────────────┐  │  │
│  │  - _id               │  │ │  │  │            AI Model Pipeline                 │  │  │
│  │  - userId            │  │ │  │  │  ┌───────────────────────────────────────┐  │  │  │
│  │  - weight            │  │ │  │  │  │       Food Recognition (YOLOv8)       │  │  │  │
│  │  - date              │  │ │  │  │  │  - Detect multiple foods in image    │  │  │  │
│  └──────────────────────┘  │ │  │  │  │  - Bounding boxes + confidence       │  │  │  │
│  ┌──────────────────────┐  │ │  │  │  │  - Class labels (101+ food classes)  │  │  │  │
│  │ ChatHistory Collection│ │ │  │  │  └───────────────────────────────────────┘  │  │  │
│  │  - _id               │  │ │  │  │  ┌───────────────────────────────────────┐  │  │  │
│  │  - userId            │  │ │  │  │  │      Portion Estimation Module        │  │  │  │
│  │  - messages[]        │  │ │  │  │  │  - Reference object detection        │  │  │  │
│  │  - createdAt         │  │ │  │  │  │  - Depth estimation (MiDaS)          │  │  │  │
│  └──────────────────────┘  │ │  │  │  │  - Volume approximation              │  │  │  │
└────────────────────────────┘ │  │  │  └───────────────────────────────────────┘  │  │
                               │  │  │  ┌───────────────────────────────────────┐  │  │
┌────────────────────────────┐ │  │  │  │     GenAI Integration (LLM API)       │  │  │
│     PostgreSQL Database    │ │  │  │  │  - OpenAI GPT-4 / GPT-3.5-turbo      │  │  │
│  ┌──────────────────────┐  │ │  │  │  │  - LLaMA 2 / Mistral (local)         │  │  │
│  │  nutrition_data      │  │ │  │  │  │  - Prompt engineering templates      │  │  │
│  │  - id                │  │ │  │  │  │  - Context-aware responses           │  │  │
│  │  - food_name         │  │ │  │  │  └───────────────────────────────────────┘  │  │
│  │  - calories_per_100g │  │ │  │  └─────────────────────────────────────────────┘  │
│  │  - protein           │  │ │  └───────────────────────────────────────────────────┘  │
│  │  - carbs             │  │ └─────────────────────────────────────────────────────────┘
│  │  - fat               │  │                          │
│  │  - fiber             │  │                          │
│  │  - glycemic_index    │  │◄─────────────────────────┘
│  │  - serving_size      │  │       Nutrition Lookup
│  │  - usda_id           │  │
│  └──────────────────────┘  │
│  ┌──────────────────────┐  │
│  │  gi_reference        │  │
│  │  - id                │  │
│  │  - food_name         │  │
│  │  - gi_value          │  │
│  │  - gi_category       │  │
│  │  - source            │  │
│  └──────────────────────┘  │
│  ┌──────────────────────┐  │
│  │  workout_templates   │  │
│  │  - id                │  │
│  │  - name              │  │
│  │  - goal_type         │  │
│  │  - difficulty        │  │
│  │  - exercises[]       │  │
│  │  - duration_mins     │  │
│  └──────────────────────┘  │
└────────────────────────────┘

```

## Data Flow Diagrams

### 1. Food Image Analysis Flow
```
┌──────────┐    ┌──────────┐    ┌──────────────┐    ┌───────────────┐    ┌──────────────┐
│  User    │───►│  React   │───►│   Node.js    │───►│  FastAPI AI   │───►│   YOLOv8     │
│  Upload  │    │ Frontend │    │   Backend    │    │  Microservice │    │   Model      │
│  Image   │    │          │    │              │    │               │    │              │
└──────────┘    └──────────┘    └──────────────┘    └───────────────┘    └──────────────┘
                                                            │                    │
                                                            ▼                    │
                                                    ┌───────────────┐            │
                                                    │   Portion     │◄───────────┘
                                                    │  Estimation   │
                                                    │   Module      │
                                                    └───────────────┘
                                                            │
                                                            ▼
┌──────────┐    ┌──────────┐    ┌──────────────┐    ┌───────────────┐
│  Display │◄───│  React   │◄───│   Node.js    │◄───│  PostgreSQL   │
│ Results  │    │ Frontend │    │   Backend    │    │  Nutrition DB │
│          │    │          │    │              │    │  (GI/Macros)  │
└──────────┘    └──────────┘    └──────────────┘    └───────────────┘
```

### 2. Personalized Plan Generation Flow
```
┌────────────────┐
│  User Profile  │
│  - Age: 28     │
│  - Gender: M   │
│  - Weight: 80  │
│  - Height: 175 │
│  - Goal: Fat   │
│    Loss        │
│  - Activity:   │
│    Moderate    │
└────────────────┘
        │
        ▼
┌────────────────────────────────────────────────────────────────────┐
│                      BMR & TDEE Calculator                          │
│                                                                     │
│  BMR (Male) = 10 × W + 6.25 × H - 5 × A + 5                        │
│  BMR = 10 × 80 + 6.25 × 175 - 5 × 28 + 5                           │
│  BMR = 800 + 1093.75 - 140 + 5 = 1758.75 kcal                      │
│                                                                     │
│  Activity Multiplier (Moderate) = 1.55                              │
│  TDEE = 1758.75 × 1.55 = 2726 kcal                                 │
│                                                                     │
│  Fat Loss Target = TDEE - 500 = 2226 kcal/day                      │
└────────────────────────────────────────────────────────────────────┘
        │
        ▼
┌────────────────────────────────────────────────────────────────────┐
│                      Macro Split Calculator                         │
│                                                                     │
│  Fat Loss Macros (40% Protein, 30% Carbs, 30% Fat):                │
│  - Protein: 2226 × 0.40 / 4 = 223g                                 │
│  - Carbs:   2226 × 0.30 / 4 = 167g                                 │
│  - Fat:     2226 × 0.30 / 9 = 74g                                  │
└────────────────────────────────────────────────────────────────────┘
        │
        ▼
┌────────────────────────────────────────────────────────────────────┐
│                    GenAI Plan Generator                             │
│                                                                     │
│  Input: User profile, calorie target, macro split, preferences     │
│                                                                     │
│  Output:                                                            │
│  ┌─────────────────────────┐  ┌─────────────────────────────────┐  │
│  │    7-Day Meal Plan      │  │      7-Day Workout Plan          │  │
│  │  - Day 1: Breakfast...  │  │  - Day 1: Upper Body Strength   │  │
│  │  - Day 1: Lunch...      │  │  - Day 2: HIIT Cardio           │  │
│  │  - Day 1: Dinner...     │  │  - Day 3: Lower Body            │  │
│  │  - Day 2: ...           │  │  - Day 4: Rest/Active Recovery  │  │
│  └─────────────────────────┘  └─────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────┘
```

### 3. Authentication Flow
```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                              JWT Authentication Flow                                  │
│                                                                                       │
│  ┌─────────┐     ┌─────────────────────────────────────────────────────────────────┐ │
│  │ Register│     │  1. User submits email + password                                │ │
│  │         │────►│  2. Server hashes password (bcrypt, 12 rounds)                  │ │
│  │         │     │  3. Store user in MongoDB                                        │ │
│  │         │     │  4. Return success                                               │ │
│  └─────────┘     └─────────────────────────────────────────────────────────────────┘ │
│                                                                                       │
│  ┌─────────┐     ┌─────────────────────────────────────────────────────────────────┐ │
│  │  Login  │     │  1. User submits email + password                                │ │
│  │         │────►│  2. Server validates credentials                                 │ │
│  │         │     │  3. Generate Access Token (JWT, 15min expiry)                   │ │
│  │         │     │  4. Generate Refresh Token (JWT, 7day expiry)                   │ │
│  │         │     │  5. Return tokens to client                                      │ │
│  └─────────┘     └─────────────────────────────────────────────────────────────────┘ │
│                                                                                       │
│  ┌─────────┐     ┌─────────────────────────────────────────────────────────────────┐ │
│  │ Access  │     │  1. Client sends request with Authorization: Bearer <token>     │ │
│  │Protected│────►│  2. Middleware validates JWT signature                          │ │
│  │ Route   │     │  3. Check token expiry                                           │ │
│  │         │     │  4. Attach user to request                                       │ │
│  │         │     │  5. Proceed to route handler                                     │ │
│  └─────────┘     └─────────────────────────────────────────────────────────────────┘ │
│                                                                                       │
│  ┌─────────┐     ┌─────────────────────────────────────────────────────────────────┐ │
│  │ Refresh │     │  1. Access token expired                                         │ │
│  │  Token  │────►│  2. Client sends refresh token to /api/auth/refresh             │ │
│  │         │     │  3. Server validates refresh token                               │ │
│  │         │     │  4. Generate new access token                                    │ │
│  │         │     │  5. Return new access token                                      │ │
│  └─────────┘     └─────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────┘
```

## Glycemic Load Calculation
```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         Glycemic Load (GL) Calculator                                │
│                                                                                      │
│  Formula: GL = (GI × Net Carbs in grams) / 100                                      │
│                                                                                      │
│  Example: White Rice (150g serving)                                                  │
│  - GI Value: 73 (High)                                                              │
│  - Total Carbs: 44g                                                                 │
│  - Fiber: 0.6g                                                                      │
│  - Net Carbs: 44 - 0.6 = 43.4g                                                      │
│  - GL = (73 × 43.4) / 100 = 31.7                                                    │
│                                                                                      │
│  GL Categories:                                                                      │
│  ┌─────────────────┬─────────────────┬─────────────────────────────────────────────┐│
│  │   Category      │    GL Range     │              Impact                          ││
│  ├─────────────────┼─────────────────┼─────────────────────────────────────────────┤│
│  │   Low           │      < 10       │   Minimal blood sugar impact                ││
│  │   Medium        │     11 - 19     │   Moderate blood sugar rise                 ││
│  │   High          │      ≥ 20       │   Significant blood sugar spike             ││
│  └─────────────────┴─────────────────┴─────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Deployment Architecture
```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Docker Compose Stack                                    │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐│
│  │                              nginx (Reverse Proxy)                               ││
│  │                                  Port: 80/443                                    ││
│  └─────────────────────────────────────────────────────────────────────────────────┘│
│                    │                      │                        │                 │
│                    ▼                      ▼                        ▼                 │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────────────┐  │
│  │   frontend:3000     │  │   backend:5000      │  │    ai-service:8000          │  │
│  │   (React + Nginx)   │  │   (Node.js)         │  │    (FastAPI + Uvicorn)      │  │
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────────────┘  │
│                                    │                        │                        │
│                    ┌───────────────┴────────────────────────┘                        │
│                    ▼                                                                 │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────────────┐  │
│  │   mongodb:27017     │  │   postgres:5432     │  │       redis:6379            │  │
│  │   (User Data)       │  │   (Nutrition DB)    │  │   (Session Cache)           │  │
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────┘
```
